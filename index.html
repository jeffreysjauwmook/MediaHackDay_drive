<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta content="True" name="HandheldFriendly">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
    <style>
        #map-page, #map-canvas {
            width: 100%;
            height: 100%;
            padding: 0;
            z-index: 200;
        }
    </style>
    <title>Mediahackday</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://code.jquery.com/jquery-1.8.2.min.js"></script>
    <script src="https://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.js"></script>
    <script src="http://maps.google.com/maps/api/js?sensor=false"></script>
    <script>
        /*
         * Google Maps documentation: http://code.google.com/apis/maps/documentation/javascript/basics.html
         * Geolocation documentation: http://dev.w3.org/geo/api/spec-source.html
         */
        var defaultLatLng = new google.maps.LatLng(34.0983425, -118.3267434);  // Default to Hollywood, CA when no geolocation support
        var map;
        var myOptions;
        var userMarker
        var markers = [];
        var colors = ['red', 'blue', 'green', 'red'];
        var markerColors = {
            red: null,
            blue: null,
            green: null,
            black: null
        };
        function drawMap(latlng) {
            myOptions = {
                zoom: 20, //23
                center: latlng,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                zIndex: 1,
                scrollwheel: false,
                navigationControl: false,
                mapTypeControl: false,
                scaleControl: false,
                draggable: false,
                streetViewControl: false,
                zoomControl: false
            };

            map = new google.maps.Map(document.getElementById("map-canvas"), myOptions);

            // Add an overlay to the map of current lat/lng
            userMarker = new google.maps.Marker({
                position: latlng,
                map: map,
                title: "This is you!"
            });
        }
        function appSetLocation(lat, long) {
            var location = new google.maps.LatLng(lat, long);
            userMarker.setPosition(location);

        }
        function createMarkers(nearByUsers) {

            for (var i = 0; i < nearByUsers.length; i++) {

                var user = nearByUsers[i];
                var userId = user.id;
                var position = user.previous_known_position;
                var userLocation = new google.maps.LatLng(position.latitude, position.longitude);
                var username = user.username;
                var image = 'img/bender-small.jpg';
                if (markers[userId] == undefined) {
                    markers[userId] = new google.maps.Marker({
                        map: map,
                        position: userLocation,
                        title: username,
                        icon: image,
                        user: user
                    });
                    google.maps.event.addListener(markers[userId], 'click', function () {
                        userMenu(markers[userId].user);
                    });
                }

            }
        }
        function getNearbyUsers(lat, long) {

            $.ajax({
                url: "http://backend.mediahackday.gehekt.nl/api/v1.0/user?format=json",
                method: "GET",
                data: {},
                cache: false,
                dataType: 'json'
            }).done(function (info) {

                createMarkers(info);

            });


        }
        function isLoggedIn() {

        }
        function userMenu(user) {
            console.log(user);
            $('.menu__bottom').addClass('open');
            $('.reply-menu').attr('data-id', user.id);


        }
        function sendMessage(user, msg) {
            $.ajax({
                url: "test.json",
                method: "POST",
                data: {user: user, msg: msg},
                cache: false,
                dataType: 'json'
            }).done(function () {
                alert('message send');

            });
        }
        function checkForNotifications() {
            $.ajax({
                url: "test.json",
                method: "POST",
                data: {user: user},
                cache: false,
                dataType: 'json'
            }).done(function () {
                getLastNotifications();
            });
        }
        function getLastNotifications() {
            $.ajax({
                url: "test.json",
                method: "POST",
                data: {user: user},
                cache: false,
                dataType: 'json'
            }).done(function () {
                getLastMessage();
            });
        }


        $(document).on("pageinit", "#map-page", function () {


            if (navigator.geolocation) {
                function success(pos) {
                    // Location found, show map with these coordinates
                    drawMap(new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude));
                }

                function fail(error) {
                    drawMap(defaultLatLng);  // Failed to find location, show default map
                }

                // Find the users current position.  Cache the location for 5 minutes, timeout after 6 seconds
                navigator.geolocation.getCurrentPosition(success, fail, {
                    maximumAge: 500000,
                    enableHighAccuracy: true,
                    timeout: 6000
                });
            } else {
                appSetLocation(defaultLatLng);  // No geolocation support, show default map
            }


        });
        $(document).ready(function () {
            $('#map-canvas').click(function () {

                if (navigator.geolocation) {
                    function success(pos) {

                        // Location found, show map with these coordinates
                        appSetLocation(pos.coords.latitude, pos.coords.longitude);
                        getNearbyUsers(pos.coords.latitude, pos.coords.longitude);
                    }

                    function fail(error) {
                        console.log(error);  // Failed to find location, show default map
                    }

                    // Find the users current position.  Cache the location for 5 minutes, timeout after 6 seconds
                    navigator.geolocation.getCurrentPosition(success, fail, {
                        maximumAge: 500000,
                        enableHighAccuracy: true,
                        timeout: 6000
                    });
                }

            });
            $('.reply-menu__option').click(function () {
                var recipient = $(this).parent().attr('data-id');
                var msg = $(this).attr('data-msg');

                console.log(recipient, msg);
                $('.menu__bottom').removeClass('open');
            });
            setInterval(function () {
                getNearbyUsers('asdad', 'asdasd')
            }, 3000);

        });
        if (window.app) {
            /* Note: Callback functions need to be global. */
            app.setGestureCallback("onGesture");
            app.setLocationCallback("onLocation");

            var b = document.getElementById("b");
            b.onclick = function () {
                app.showMessage("You clicked the button.");
            };
        }

    </script>
</head>
<body class="no-drive speed-low">
<header class="menu__top notification">
    <span class="notification__avatar avatar"></span>
        <span class="notification__title">
            Thanks!
        </span>
        <span class="notification__details">
            BMW Z4, red
        </span>
    <span class="button notification__reply"></span>
</header>
<main class="main-content">


    <span class="avatar road-owner"></span>

    <span class="button alert js-toggle__bottom"></span>
    <span class="button notification js-toggle__top"></span>

    <div data-role="page" id="map-page" data-url="map-page">

        <div role="main" class="ui-content" id="map-canvas">
            <!-- map loads here... -->
        </div>
    </div>

</main>
<footer class="menu__bottom">
    <ul class="reply-menu">
        <li class="reply-menu__option" data-msg="1">Thanks</li>
        <li class="reply-menu__option" data-msg="2">No Problem</li>
        <li class="reply-menu__option" data-msg="3">Sorry!</li>
        <li class="reply-menu__option" data-msg="4">WTF!</li>
    </ul>
</footer>


<script src="js/jquery.js"></script>
<script src="js/animate.js"></script>
</body>
</html>